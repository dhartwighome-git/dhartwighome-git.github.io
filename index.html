<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bread and wine - Manage your stock</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <script type="module">

        /*
            To do:
            - save custom column
            - retrieve columns
            - update columns
            - show / hide columns
            - delete column
        */

        /* Initialise Firestore database */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        // const auth = getAuth();

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA73guwI5BCtkvaqLUgBkQKc9zF209fNR0",
            authDomain: "bread-and-wine.firebaseapp.com",
            projectId: "bread-and-wine",
            storageBucket: "bread-and-wine.firebasestorage.app",
            messagingSenderId: "754486129562",
            appId: "1:754486129562:web:1194bd45b506597857c023"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        function toCamelCase(str) {
            return str
                .replace(/[^a-zA-Z0-9 ]+/g, '')      // remove non-alphanumeric
                .replace(/\s+(.)/g, (_, chr) => chr.toUpperCase()) // capitalize letters after spaces
                .replace(/^(.)/, (_, chr) => chr.toLowerCase());   // lowercase first letter
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                loginForm.style.display = "none";
                userPanel.style.display = "block";
                userEmailSpan.textContent = `Logged in as: ${user.email}`;
                renderTable();
            } else {
                loginForm.style.display = "block";
                userPanel.style.display = "none";
                document.getElementById("inventory").innerHTML = "";
            }
        });

        async function fetchProducts() {
            const snapshot = await getDocs(collection(db, "products"));
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function fetchColumns() {
            const snapshot = await getDocs(collection(db, "columns"));
            return snapshot.docs
                .map(col => ({ id: col.id, ...col.data() }))
                .sort((a, b) => a.order - b.order);
        }

        function getColumnOptions(products, columnKey) {
            const values = new Set();

            products.forEach(product => {
                const value = product[columnKey];
                if (value) {
                    values.add(value);
                }
            });

            return Array.from(values);
            }

        async function editRow(rowIndex, product, products) {
            const table = document.getElementById("inventory");
            const row = table.rows[rowIndex + 1]; // skip header
            const columns = await fetchColumns();

            // Clear row
            row.innerHTML = "";

            // Create editable cells
            columns.forEach(col => {
                const cell = row.insertCell();

                // Render selects with options
                if (col.type === "select") {
                    const select = document.createElement("select");
                    const colOptions = getColumnOptions(products, col.key);

                    col.options.forEach(opt => {
                        const o = document.createElement("option");
                        o.value = opt;
                        o.textContent = opt;
                        select.appendChild(o);
                    });

                    colOptions.forEach(opt => {
                        const o = document.createElement("option");
                        o.value = opt;
                        o.textContent = opt;
                        select.appendChild(o);
                    });

                    if (col.allowCustom) {
                        const customOpt = document.createElement("option");
                        customOpt.value = "__custom__";
                        customOpt.textContent = "Custom...";
                        select.appendChild(customOpt);
                    }
                    console.log("Current value:", product[col.key])
                    const val = product[col.key] ?? "";
                    select.value = val;
                    select.dataset.key = col.key;

                    select.addEventListener("change", () => {
                        if (select.value === "__custom__") {
                            const input = document.createElement("input");
                            input.type = "text";
                            input.placeholder = "Enter custom value";
                            input.dataset.key = col.key;
                            select.replaceWith(input);
                        }
                    });

                    cell.appendChild(select);
                }
                // Render inputs
                else {
                    const input = document.createElement("input");
                    input.value =
                        product[col.key]?.text ??
                        product[col.key] ??
                        "";
                    input.dataset.key = col.key;
                    input.type = col.type === "number" ? "number" :
                                col.type === "date" ? "date" : "text";

                    cell.appendChild(input);
                }
            });

            // Actions cell
            const actionsCell = row.insertCell();

            const saveBtn = document.createElement("button");
            saveBtn.textContent = "Save";
            saveBtn.className = "saveButton";
            saveBtn.addEventListener("click", () => saveRow(product.id, rowIndex));

            const cancelBtn = document.createElement("button");
            cancelBtn.textContent = "Cancel";
            cancelBtn.className = "cancelButton";
            cancelBtn.addEventListener("click", renderTable);

            actionsCell.append(saveBtn, cancelBtn);
        }

        function lockRow(index, product) {
            renderTable();
        }

        async function saveRow(productId, rowIndex) {
            const table = document.getElementById("inventory");
            const row = table.rows[rowIndex + 1];
            const fields = row.querySelectorAll("input, select");

            const updatedData = {};

            fields.forEach(field => {
                console.log(field.dataset.key, " = ", field.value);
                updatedData[field.dataset.key] = field.value;
            });

            console.log([...row.querySelectorAll("input, select")]);

            await updateDoc(doc(db, "products", productId), updatedData);
            renderTable();
        }

        async function deleteRow(id, index) {
            const confirmed = confirm("Are you sure?");
            if (!confirmed) return;

            try {
                console.log("Deleting product:", id)
                await deleteDoc(doc(db, "products", id));
                renderTable();
            } catch (err) {
                console.error(err);
                alert("Unable to delete product.")
            }
        }

        async function renderTable() {
            /*  To do:
                -   Retrieve Firestore columns:
                    const cols = fetchColumns();

                -   Iterate over columns to make the header:
                    columns.forEach(col => { ... });

                -   Iterate over products to make rows:
                    products.forEach(product => {
                        const row = document.createElement("tr");
                    };

                -   In each row, iterate over columns to make cells:
                    columns.forEach(col => {
                        const td = document.createElement("td");
                        td.textContent = product[col.key] ?? "";
                        row.appendChild(td);
                    });
            */

            const table = document.getElementById("inventory");
            table.innerHTML = "";
            const products = await fetchProducts();
            // table.innerHTML = "<tr><th>Name</th><th>Count</th><th>Price</th><th><button id='addColumnBtn'>+<button></th></tr>";
            const headerRow = document.createElement("tr");

            // Get columns from Firestore
            const columns = await fetchColumns();

            // To do: add hide button to each column
            for (const column of columns) {
                const th = document.createElement("th");
                th.textContent = column.keyText;
                headerRow.appendChild(th);
            }

            const actionTh = document.createElement("th");
            const addColBtn = document.createElement("button");
            addColBtn.textContent = "+";
            addColBtn.addEventListener("click", () => {
                addColumnForm.classList.toggle("hidden");
                // click newKeyBtn
                addColumnRow();
            });
            actionTh.appendChild(addColBtn);

            headerRow.appendChild(actionTh);
            table.appendChild(headerRow);

            // Create table rows dynamically
            products.forEach((item, index) => {
                const row = table.insertRow(-1); // add row at the end

                for (const col of columns) {
                    const cell = row.insertCell();
                    const value = item[col.key];

                    // console.log(item)

                    cell.textContent = value ?? "";
                }

                const actionsCell = row.insertCell();
                actionsCell.className = "actions";

                // Edit button
                const editBtn = document.createElement("button");
                editBtn.textContent = "Edit";
                editBtn.className = "editButton";
                editBtn.addEventListener("click", () => editRow(index, item, products));
                actionsCell.appendChild(editBtn);

                // Delete button
                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "Delete";
                deleteBtn.className = "deleteButton";
                deleteBtn.addEventListener("click", () => deleteRow(item.id, index));
                actionsCell.appendChild(deleteBtn);

                // (To do) Add remaining keys, values if custom exist
            });

            // Add a "New Item" button and show addForm

        }

        const loginForm = document.getElementById("loginForm");
        const userPanel = document.getElementById("userPanel");
        const userEmailSpan = document.getElementById("userEmail");

        loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const email = loginForm.email.value;
        const password = loginForm.password.value;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            // Optional: hide login form and show main app
            loginForm.style.display = "none";
            userPanel.style.display = "block";
            userEmailSpan.textContent = `Logged in as: ${user.email}`;
            renderTable(); // fetch products after login
        } catch (error) {
            console.error(error.code, error.message);
            alert("Login failed: " + error.message);
        }
        });

        // Sign Out
        signOutBtn.addEventListener("click", async () => {
            await signOut(auth);

            // Reset UI
            loginForm.style.display = "block";
            userPanel.style.display = "none";
            loginForm.reset();
            document.getElementById("inventory").innerHTML = ""; // clear table
        });

        // To do: hide addForm, show when "+" is clicked

        const form = document.getElementById("addForm")

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = form.name.value;
            const qty = Number(form.quantity.value);
            const price = Number(form.price.value);

            // (To do) Add customForm for custom product categories

            /* Validate */
            if (!name) {
                alert("Please enter a product name!");
                return;
            }
            if (qty<0) {
                alert("Please enter a valid product count!");
                return;
            }
            if (price<0) {
                alert("Please enter a valid price!");
                return;
            }

            // Check custom fields

            try {
                await addDoc(collection(db, "products"), {
                    name: name,
                    quantity: qty,
                    price: price
                    // Custom fields
                });
                form.reset();
                renderTable();
            }
            catch (err) {
                console.error(err);
                alert("Could not add product.")
            }
                       
        });

        // Create a new product category column (e.g., "Weight", "Best Before" etc.)
        const newColumnForm = document.getElementById("addColumnForm");

        newColumnForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Save new column to firestore
            const rows = newColumnForm.querySelectorAll(".column-row");

            for (const row of rows) {
                const columns = await fetchColumns();
                const existingKeys = columns.map(c => c.keyText);

                const column = row.querySelector("input").value;
                const type = row.querySelector("select").value;

                // Check input
                if (!column) {
                    alert("Invalid input");
                    return;
                }

                if (existingKeys.includes(column)) {
                    alert("Column already exists.");
                    return;
                }

                const columnData = {
                        key: toCamelCase(column),
                        keyText: column,
                        type: type,
                        active: true,
                        order: existingKeys.length
                    }

                // Store select options, allow custom options
                if (type === "select") {
                    const options = [...row.querySelectorAll(".optionInput")]
                        .map(i => i.value)
                        .filter(Boolean);

                    const allowCustom = row.querySelector(".allow-custom")?.checked ?? true;
                    
                    if (!allowCustom && options.length === 0) {
                        alert("Either allow custom options or provide at least 1 option.");
                        return;
                    }

                    columnData.options = options;
                    columnData.allowCustom = allowCustom;
                }

                console.log(columnData)
                
                // Save to Firestore
                try {
                    await addDoc(collection(db, "columns"), columnData);
                    resetAddColumnForm();
                    renderTable();
                }
                catch (err) {
                    console.error(err);
                    alert("Could not add column.");
                }
            }
        })

        function resetAddColumnForm() {
            addColumnForm.classList.add("hidden");

            // Remove all rows except the first
            const rows = Array.from(addColumnForm.querySelectorAll("div"));
            rows.forEach((row, i) => {
                if (i !== 0) row.remove();
            });

            // Optionally, reset the first row inputs
            const firstRowInputs = rows[0]?.querySelectorAll("input, select");
            firstRowInputs?.forEach(input => {
                if (input.tagName === "INPUT") input.value = "";
                if (input.tagName === "SELECT") input.selectedIndex = 0;
            });
        }

        const cancelBtn = document.getElementById("columnCancelBtn");

        cancelBtn.addEventListener("click", () => {
            resetAddColumnForm();
        });

        function addColumnRow() {
            const row = document.createElement("div");
            row.className = "column-row";

            // Key input
            const keyLabel = document.createElement("label");
            keyLabel.textContent = "Key:";
            row.appendChild(keyLabel);

            const keyInput = document.createElement("input");
            keyInput.placeholder = "Column key";
            row.appendChild(keyInput);

            // Datatype select
            const typeLabel = document.createElement("label");
            typeLabel.textContent = "Datatype:";
            row.appendChild(typeLabel);

            // To do: add "select" option
            const typeSelect = document.createElement("select");
            ["text", "number", "date", "select"].forEach(type => {
                const option = document.createElement("option");
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });
            row.appendChild(typeSelect);

            typeSelect.addEventListener("change", () => {
                if (typeSelect.value === "select") {
                    createSelectForm(row);
                } else {
                    removeSelectForm(row);
                }
            });

            // Remove button
            const removeKeyBtn = document.createElement("button");
            removeKeyBtn.type = "button";
            removeKeyBtn.textContent = "-";
            removeKeyBtn.addEventListener("click", () => row.remove());
            row.appendChild(removeKeyBtn);

            // Insert row above Cancel/Save buttons
            addColumnForm.insertBefore(row, newKeyBtn);
        }

        newKeyBtn.addEventListener("click", () => {
            addColumnRow();
        });

        function createSelectForm(row) {
            if (row.querySelector(".select-form")) return;

            const form = document.createElement("div");
            form.className = "select-form";

            const optionsContainer = document.createElement("div");
            optionsContainer.className = "options-container";

            form.appendChild(optionsContainer);
            addOptionRow(optionsContainer);

            // + button
            const addBtn = document.createElement("button");
            addBtn.type = "button";
            addBtn.textContent = "+";
            addBtn.addEventListener("click", () => addOptionRow(optionsContainer));

            // Allow custom checkbox
            const customLabel = document.createElement("label");
            const customCheckbox = document.createElement("input");
            customCheckbox.type = "checkbox";
            customCheckbox.className = "allow-custom";

            customLabel.append(customCheckbox, "Allow custom options");

            // Optional update: Get options from cell / column / table

            form.append(addBtn, customLabel);
            row.appendChild(form);
        }

        // Remove form if it exists
        function removeSelectForm(row) {
            const selectForm = row.querySelector(".select-form");
            if (selectForm) {
                selectForm.remove();
            }
        }

        function addOptionRow(container) {
            const div = document.createElement("div");
            div.className = "option-row";

            const input = document.createElement("input");
            input.placeholder = "Option value";
            input.className = "optionInput";

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.textContent = "-";
            removeBtn.addEventListener("click", () => div.remove());

            div.append(input, removeBtn);
            container.appendChild(div);
        }

    </script>

    <header>
        <form id="loginForm">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>

        <div id="userPanel" style="display:none">
            <span id="userEmail"></span>
            <button id="signOutBtn">Sign Out</button>
        </div>
    </header>
    
    <main>
        <h1>My current stock</h1>

        <table id="inventory"></table>

        <form id="addForm">
            <h3>Add new item</h3>
            <input type="text" name="name" placeholder="New item">
            <input type="number" name="quantity" placeholder="1x">
            <input type="number" step="0.01" name="price" placeholder="Price"">
            
            <button type="submit">Save</button>
            <button type="reset">Clear</button>
        </form>
        
        <form id="addColumnForm" class="hidden">
            <h3>Add new column</h3>
            <div>

            </div>
            
            <button type="button" id="newKeyBtn">+</button>
            <br>
            <button type="button" id="columnCancelBtn">Cancel</button>
            <button type="submit">Save</button>    
        </form>
    </main>

    

</body>